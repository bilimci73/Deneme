<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Mobile FPS PvP</title>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:black}
canvas{display:block}
#ui{position:fixed;inset:0;z-index:20;pointer-events:none}
#ui *{pointer-events:auto;touch-action:none}
#crosshair{position:fixed;top:50%;left:50%;width:18px;height:18px;transform:translate(-50%,-50%)}
#crosshair:before,#crosshair:after{content:"";position:absolute;background:white}
#crosshair:before{width:2px;height:18px;left:8px}
#crosshair:after{width:18px;height:2px;top:8px}
#health{position:fixed;top:20px;left:120px;color:white;background:rgba(0,0,0,.5);padding:6px 10px;border-radius:6px}
button{background:rgba(0,0,0,.65);color:white;border:none}
#fireBtn{position:fixed;top:15px;left:15px;width:85px;height:85px;border-radius:50%;font-size:30px}
#fullscreenBtn{position:fixed;top:15px;right:15px;width:50px;height:50px;border-radius:50%}
#settingsBtn{position:fixed;top:15px;left:50%;transform:translateX(-50%);width:50px;height:50px;border-radius:50%}
#settings{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);padding:10px;border-radius:8px;color:white;display:none}
#jumpBtn{position:fixed;bottom:25px;right:25px;width:90px;height:90px;border-radius:50%}
#joystick{position:fixed;bottom:20px;left:20px;width:120px;height:120px;background:rgba(255,255,255,.15);border-radius:50%}
#stick{position:absolute;left:40px;top:40px;width:40px;height:40px;background:rgba(255,255,255,.6);border-radius:50%}
#roomUI{position:fixed;top:90px;left:50%;transform:translateX(-50%);z-index:30}
</style>
</head>

<body>
<div id="crosshair"></div>

<div id="roomUI">
  <input id="nameInput" placeholder="ƒ∞smin">
  <input id="roomId" placeholder="ODA KODU">
  <button onclick="host()">Oda Kur</button>
  <button onclick="join()">Katƒ±l</button>
</div>

<div id="ui">
<button id="fireBtn">üî´</button>
<div id="health">‚ù§Ô∏è 100</div>
<button id="settingsBtn">‚öôÔ∏è</button>
<button id="fullscreenBtn">‚õ∂</button>
<div id="settings">Hassasiyet<br><input id="sens" type="range" min="0.001" max="0.01" step="0.001" value="0.003"></div>
<div id="joystick"><div id="stick"></div></div>
<button id="jumpBtn">Zƒ±pla</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
/* === MULTIPLAYER === */
let peer, conns=[], players={}, myName="Player";
function host(){
  myName=nameInput.value||"Host";
  peer=new Peer();
  peer.on("open",id=>alert("ODA KODU: "+id));
  peer.on("connection",c=>{
    conns.push(c);
    c.on("data",d=>net(d,c.peer));
  });
}
function join(){
  myName=nameInput.value||"Player";
  peer=new Peer();
  peer.on("open",()=>{
    const c=peer.connect(roomId.value);
    conns.push(c);
    c.on("data",d=>net(d,c.peer));
  });
}
function send(d){conns.forEach(c=>c.send(d));}

function net(d,id){
  if(!players[id]){
    const body=new THREE.Mesh(
      new THREE.CapsuleGeometry(0.4,1),
      new THREE.MeshStandardMaterial({color:0x00ff00})
    );
    body.health=100;
    body.name=d.name||"Player";
    body.label=makeLabel(body.name);
    scene.add(body,body.label);
    players[id]=body;
  }
  const p=players[id];
  if(d.pos){p.position.copy(d.pos);p.rotation.y=d.yaw;}
  if(d.hit){
    p.health-=20;
    if(p.health<=0){
      p.health=100;
      p.position.set(Math.random()*10-5,0,Math.random()*10-5);
    }
  }
}

/* === LABEL === */
function makeLabel(text){
  const c=document.createElement("canvas");
  c.width=256;c.height=64;
  const ctx=c.getContext("2d");
  ctx.fillStyle="white";
  ctx.font="32px sans-serif";
  ctx.textAlign="center";
  ctx.fillText(text,128,40);
  const t=new THREE.CanvasTexture(c);
  const s=new THREE.Sprite(new THREE.SpriteMaterial({map:t}));
  s.scale.set(2,0.5,1);
  s.position.y=1.6;
  return s;
}

/* === THREE FPS === */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);
const camera=new THREE.PerspectiveCamera(75,1,0.1,1000);
camera.position.y=1.6;
const renderer=new THREE.WebGLRenderer({antialias:true});
document.body.appendChild(renderer.domElement);

function resize(){
  const w=innerWidth,h=visualViewport?visualViewport.height:innerHeight;
  camera.aspect=w/h;camera.updateProjectionMatrix();
  renderer.setSize(w,h);
}
resize();
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));
const floor=new THREE.Mesh(new THREE.PlaneGeometry(200,200),new THREE.MeshStandardMaterial({color:0x555555}));
floor.rotation.x=-Math.PI/2;scene.add(floor);

const player=new THREE.Object3D();player.add(camera);scene.add(player);

/* Movement */
let moveX=0,moveZ=0,yaw=0,pitch=0,velY=0,grounded=false;
let sensitivity=0.003;
sens.oninput=e=>sensitivity=parseFloat(e.target.value);

/* Joystick */
const joystick=document.getElementById("joystick"),stick=document.getElementById("stick");
let joyId=null;
joystick.addEventListener("touchstart",e=>joyId=e.changedTouches[0].identifier,{passive:false});
joystick.addEventListener("touchmove",e=>{
  for(const t of e.touches)if(t.identifier===joyId){
    const r=joystick.getBoundingClientRect();
    let x=t.clientX-r.left-60,y=t.clientY-r.top-60;
    const d=Math.min(40,Math.hypot(x,y)),a=Math.atan2(y,x);
    x=Math.cos(a)*d;y=Math.sin(a)*d;
    stick.style.left=40+x+"px";stick.style.top=40+y+"px";
    moveX=x/40;moveZ=y/40;
  }
},{passive:false});
joystick.addEventListener("touchend",()=>{joyId=null;moveX=moveZ=0;stick.style.left="40px";stick.style.top="40px";});

/* Look */
let lookId=null,lx=0,ly=0;
addEventListener("touchstart",e=>{
  for(const t of e.changedTouches)
    if(!t.target.closest("#joystick")&&lookId===null){lookId=t.identifier;lx=t.clientX;ly=t.clientY;}
});
addEventListener("touchmove",e=>{
  for(const t of e.touches)if(t.identifier===lookId){
    yaw-=(t.clientX-lx)*sensitivity;
    pitch-=(t.clientY-ly)*sensitivity;
    pitch=Math.max(-1.5,Math.min(1.5,pitch));
    lx=t.clientX;ly=t.clientY;
  }
});
addEventListener("touchend",e=>{for(const t of e.changedTouches)if(t.identifier===lookId)lookId=null;});

/* Jump */
jumpBtn.addEventListener("touchstart",e=>{
  e.preventDefault();
  if(grounded){velY=0.26;grounded=false;}
},{passive:false});

/* Fire */
const ray=new THREE.Raycaster();
fireBtn.addEventListener("touchstart",e=>{
  e.preventDefault();
  ray.setFromCamera(new THREE.Vector2(0,0),camera);
  for(const id in players){
    const hit=ray.intersectObject(players[id]);
    if(hit.length) send({hit:true});
  }
},{passive:false});

/* Loop */
function animate(){
  requestAnimationFrame(animate);
  player.rotation.y=yaw;
  camera.rotation.x=pitch;
  const f=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
  const r=new THREE.Vector3(Math.cos(yaw),0,-Math.sin(yaw));
  player.position.add(f.multiplyScalar(moveZ*0.07));
  player.position.add(r.multiplyScalar(moveX*0.07));
  velY-=0.009;player.position.y+=velY;grounded=false;
  if(player.position.y<=0){player.position.y=0;velY=0;grounded=true;}
  send({pos:player.position,yaw,name:myName});
  renderer.render(scene,camera);
}
animate();
addEventListener("resize",resize);
</script>
</body>
</html>

